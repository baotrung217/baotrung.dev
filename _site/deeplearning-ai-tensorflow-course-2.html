<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<!-- block search indexing -->
	<meta name="robots" content="noindex">
	<meta name="googlebot" content="noindex">

  <!-- bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous" async>

  <!-- fontawesome -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous" async>

  <!-- google fonts -->
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin async >
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&display=swap" rel="stylesheet" crossorigin async>
  <link href="https://fonts.googleapis.com/css?family=Livvic:400,400i,500,500i,600&display=swap&subset=vietnamese" rel="stylesheet" crossorigin async>
  <link href="https://fonts.googleapis.com/css?family=Lobster&display=swap" rel="stylesheet" crossorigin async>

  <link rel="alternate" hreflang="en" href="/deeplearning-ai-tensorflow-course-2" async />

  <link rel="shortcut icon" type="image/x-icon" href="/img/avatar-icon.ico" async>
  <meta name="author" content="Nguyễn Bảo Trung" />

  <title>
    
      Trung | TF 2 - CNN in TensorFlow
    
  </title>

  

  <!-- feed -->
  <link rel="alternate" type="application/rss+xml" title="Nguyễn Bảo Trung - " href="/feed.xml" async />

  <!-- page (internal) -->
  

  <!-- layout (internal) -->
  
    
      <link rel="stylesheet" href="/css/main.css" async />
    
      <link rel="stylesheet" href="/css/rouge-thi.css" async />
    
  
  

    <!-- Facebook OpenGraph tags -->
  

  
    <meta property="fb:admins" content="baotrung217zzz"/>
  

  
    <meta property="og:title" content="TF 2 - CNN in TensorFlow" />
  

  
    <meta property="og:description" content="Larger dataset Extract zip file + view image image to np array Plot loss and acc Cats vs dogs os Split data Define model Generate data Train Image Augmentation Transfer learning Multi-class classification More References This is my note for the 2nd course of TensorFlow in Practice Specialization given by...">
  


  <meta property="og:type" content="website" />

  
    <meta property="og:url" content="http://localhost:4000/deeplearning-ai-tensorflow-course-2" />
    <link rel="canonical" href="http://localhost:4000/deeplearning-ai-tensorflow-course-2" async />
  

  <meta property="og:image" content="http://localhost:4000/img/background.png" />
  <meta property="og:image:type" content="image/png">
  <meta property="og:image:width" content="1234">
  <meta property="og:image:height" content="592">

  

  

  

  

</head>


<body>
  <script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '',
      xfbml      : true,
      version    : 'v3.1'
    });
  
    FB.AppEvents.logPageView();
  
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>
  <header>
    <nav class="navbar navbar-dark nav-bg navbar-custom fixed-top">
  <div class="container">
    <div class="col-12 col-lg-10 offset-lg-1">
      <div class="nav-container">
        <a class="nav-item" href="http://localhost:4000/">
          <i style="color: #ffeead;" class="fas fa-home" aria-hidden="true"></i>
          <span>Home</span>
        </a>
        <a class="nav-item" href="http://localhost:4000/about">
          <i style="color: #e97c8e;" class="fas fa-fire" aria-hidden="true"></i>
          <span>Me</span>
        </a>
        <a class="nav-item" href="http://localhost:4000/notes">
          <i style="color: #93ceff;" class="fas fa-edit" aria-hidden="true"></i>
          <span>Notes</span>
        </a>
        <div class="nav-search">
          <form action="http://localhost:4000/search" method="get">
            <button class="nav-search-submit" type="submit">
              <i class="fa fa-search" aria-hidden="true"></i>
            </button>
            <input name="q" class="nav-search-input" type="search" placeholder="search notes..." aria-label="search notes...">
          </form>
        </div>
        <a class="nav-item nav-github" href="https://github.com/baotrung217" target="_blank">
          <i class="fab fa-github"></i>
        </a>
    </div>
    </div>
  </div>
</nav>

  </header>

  
  <header class="header">
    <div class="container">
      <div class="row align-items-center justify-content-center">
        <div class="col-md-8 header-content">
          
          
            <div class="icon-photo">
              <img src="http://localhost:4000/img/header/tensorflow.svg">
            </div>
          
          <h1 class="post-title">
            TF 2 - CNN in TensorFlow
          </h1>
          
            <div class="tag-in-post">
              
              
                
                
                
                
                
                  <a href="/tags#coursera">
                    coursera
                  </a>
                

              
                
                
                
                
                
                  <a href="/tags#deeplearning-ai">
                    deeplearning.ai
                  </a>
                

              
                
                
                
                
                
                  <a href="/tags#mooc">
                    mooc
                  </a>
                

              
                
                
                
                
                
                  <a href="/tags#tensorflow">
                    tensorflow
                  </a>
                

              
            </div>
          
          <p>
            
              24 Aug 2020
                        
          </p>
        </div>
      </div>
    </div>
  </header>


<main role="main">
  <section class="section">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-10 col-xl-9">
          <article  class="page-content ">
            <p style="font-style: italic; color: #777; font-size: 0.95rem; margin-bottom: 2rem;">
  Last modified on 01 May 2022.
</p>




<div id="toc">
  <div class="toc-content">
<ul id="markdown-toc">
  <li><a href="#larger-dataset" id="markdown-toc-larger-dataset">Larger dataset</a>    <ul>
      <li><a href="#extract-zip-file--view-image" id="markdown-toc-extract-zip-file--view-image">Extract zip file + view image</a></li>
      <li><a href="#image-to-np-array" id="markdown-toc-image-to-np-array">image to np array</a></li>
      <li><a href="#plot-loss-and-acc" id="markdown-toc-plot-loss-and-acc">Plot loss and acc</a></li>
    </ul>
  </li>
  <li><a href="#cats-vs-dogs" id="markdown-toc-cats-vs-dogs">Cats vs dogs</a>    <ul>
      <li><a href="#os" id="markdown-toc-os">os</a></li>
      <li><a href="#split-data" id="markdown-toc-split-data">Split data</a></li>
      <li><a href="#define-model" id="markdown-toc-define-model">Define model</a></li>
      <li><a href="#generate-data" id="markdown-toc-generate-data">Generate data</a></li>
      <li><a href="#train" id="markdown-toc-train">Train</a></li>
    </ul>
  </li>
  <li><a href="#image-augmentation" id="markdown-toc-image-augmentation">Image Augmentation</a></li>
  <li><a href="#transfer-learning" id="markdown-toc-transfer-learning">Transfer learning</a></li>
  <li><a href="#multi-class-classification" id="markdown-toc-multi-class-classification">Multi-class classification</a></li>
  <li><a href="#more" id="markdown-toc-more">More</a></li>
  <li><a href="#references" id="markdown-toc-references">References</a></li>
</ul>

  </div>
</div>

<p>This is my note for the <a href="https://www.coursera.org/learn/convolutional-neural-networks-tensorflow">2nd course</a> of <a href="https://www.coursera.org/specializations/tensorflow-in-practice">TensorFlow in Practice Specialization</a> given by <a href="http://deeplearning.ai/">deeplearning.ai</a> and taught by Laurence Moroney on Coursera.</p>

<p>👉 Check the codes <a href="https://github.com/dinhanhthi/deeplearning.ai-courses/tree/master/TensorFlow%20in%20Practice">on my Github</a>.<br />
👉 Official <a href="https://github.com/lmoroney/dlaicourse">notebooks</a> on Github.</p>

<p>👉 Go to <a href="/deeplearning-ai-tensorflow-course-1">course 1 - Intro to TensorFlow for AI, ML, DL</a>.<br />
👉 Go to <a href="/deeplearning-ai-tensorflow-course-3">course 3 - NLP in Tensorflow</a>.<br />
👉 Go to <a href="/deeplearning-ai-tensorflow-course-4">course 4 - Sequences, Time Series and Prediction</a>.</p>

<h2 id="larger-dataset">Larger dataset</h2>

<ul class="noindent">
  <li><a href="https://www.kaggle.com/c/dogs-vs-cats">Kaggle Dogs v Cats dataset</a> - very famous dataset on Kaggle.</li>
  <li>Crop an image make the predict better!</li>
  <li>Make a larger dataset by rotating, scaling, cropping,…</li>
</ul>

<h3 id="extract-zip-file--view-image">Extract zip file + view image</h3>

<div class="flex-50">
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># extract zip file
</span><span class="kn">import</span> <span class="nn">zipfile</span>

<span class="n">local_zip</span> <span class="o">=</span> <span class="s">'file.zip'</span>
<span class="n">zip_ref</span> <span class="o">=</span> <span class="n">zipfile</span><span class="p">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">local_zip</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span>
<span class="n">zip_ref</span><span class="p">.</span><span class="n">extractall</span><span class="p">(</span><span class="s">'/tmp'</span><span class="p">)</span>
<span class="n">zip_ref</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>  </div>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># show image
</span><span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="n">mpimg</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="n">img</span> <span class="o">=</span> <span class="n">mpimg</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>  </div>
</div>

<h3 id="image-to-np-array">image to np array</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">keras.preprocessing</span> <span class="kn">import</span> <span class="n">image</span>

<span class="n">path</span> <span class="o">=</span> <span class="s">'./image.png'</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">load_img</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">img_to_array</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">images</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">x</span><span class="p">])</span>

<span class="n">classes</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="plot-loss-and-acc">Plot loss and acc</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit</span><span class="p">(...)</span>
<span class="n">acc</span>      <span class="o">=</span> <span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span>     <span class="s">'accuracy'</span> <span class="p">]</span>
<span class="n">val_acc</span>  <span class="o">=</span> <span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span> <span class="s">'val_accuracy'</span> <span class="p">]</span>
<span class="n">loss</span>     <span class="o">=</span> <span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span>    <span class="s">'loss'</span> <span class="p">]</span>
<span class="n">val_loss</span> <span class="o">=</span> <span class="n">history</span><span class="p">.</span><span class="n">history</span><span class="p">[</span><span class="s">'val_loss'</span> <span class="p">]</span>
</code></pre></div></div>

<div class="flex-50">
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot accuracy
</span><span class="n">plt</span><span class="p">.</span><span class="n">plot</span>  <span class="p">(</span> <span class="n">epochs</span><span class="p">,</span>     <span class="n">acc</span> <span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span>  <span class="p">(</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">val_acc</span> <span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span> <span class="p">(</span><span class="s">'Training and validation acc'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">()</span>
</code></pre></div>  </div>

  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># plot loss function
</span><span class="n">plt</span><span class="p">.</span><span class="n">plot</span>  <span class="p">(</span> <span class="n">epochs</span><span class="p">,</span>     <span class="n">loss</span> <span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span>  <span class="p">(</span> <span class="n">epochs</span><span class="p">,</span> <span class="n">val_loss</span> <span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span> <span class="p">(</span><span class="s">'Training and validation loss'</span><span class="p">)</span>
</code></pre></div>  </div>
</div>

<h2 id="cats-vs-dogs">Cats vs dogs</h2>

<h3 id="os">os</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">base_dir</span> <span class="o">=</span> <span class="s">'/tmp/cats-v-dogs'</span>
<span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">base_dir</span><span class="p">)</span>

<span class="n">train_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'training'</span><span class="p">)</span>
<span class="n">validation_dir</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s">'testing'</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">train_dir</span><span class="p">)</span>
<span class="n">os</span><span class="p">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">validation_dir</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">DIRECTORY</span><span class="p">)</span> <span class="c1"># gives you a listing of the contents of that directory
</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">PATH</span><span class="p">)</span> <span class="c1"># gives you the size of the file
</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span><span class="p">)</span> <span class="c1"># copies a file from source to destination
</span><span class="n">random</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">))</span> <span class="c1"># shuffles a list
</span></code></pre></div></div>

<h3 id="split-data">Split data</h3>

<p>Shuffle images and split/copy images to training/testing folder for each cat and dog.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">split_data</span><span class="p">(</span><span class="n">SOURCE</span><span class="p">,</span> <span class="n">TRAINING</span><span class="p">,</span> <span class="n">TESTING</span><span class="p">,</span> <span class="n">SPLIT_SIZE</span><span class="p">):</span>
    <span class="n">lst_cat_imgs</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">SOURCE</span><span class="p">)</span>
    <span class="n">lst_cat_imgs</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="n">lst_cat_imgs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst_cat_imgs</span><span class="p">))</span>
    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">lst_cat_imgs</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="n">SPLIT_SIZE</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">lst_cat_imgs</span><span class="p">))]:</span>
        <span class="n">source_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">SOURCE</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="n">destination_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">TRAINING</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">copyfile</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="n">destination_file</span><span class="p">)</span>
    <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">lst_cat_imgs</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">SPLIT_SIZE</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">lst_cat_imgs</span><span class="p">)):]:</span>
        <span class="n">source_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">SOURCE</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="n">destination_file</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">TESTING</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">copyfile</span><span class="p">(</span><span class="n">source_file</span><span class="p">,</span> <span class="n">destination_file</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CAT_SOURCE_DIR</span> <span class="o">=</span> <span class="s">"/tmp/PetImages/Cat/"</span>
<span class="n">TRAINING_CATS_DIR</span> <span class="o">=</span> <span class="s">"/tmp/cats-v-dogs/training/cats/"</span>
<span class="n">TESTING_CATS_DIR</span> <span class="o">=</span> <span class="s">"/tmp/cats-v-dogs/testing/cats/"</span>
<span class="n">split_size</span> <span class="o">=</span> <span class="p">.</span><span class="mi">9</span>
<span class="n">split_data</span><span class="p">(</span><span class="n">CAT_SOURCE_DIR</span><span class="p">,</span> <span class="n">TRAINING_CATS_DIR</span><span class="p">,</span> <span class="n">TESTING_CATS_DIR</span><span class="p">,</span> <span class="n">split_size</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="define-model">Define model</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">3</span><span class="p">)),</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Flatten</span><span class="p">(),</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">),</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="n">RMSprop</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">),</span> <span class="n">loss</span><span class="o">=</span><span class="s">'binary_crossentropy'</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s">'acc'</span><span class="p">])</span>
</code></pre></div></div>

<h3 id="generate-data">Generate data</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TRAINING_DIR</span> <span class="o">=</span> <span class="s">"/tmp/cats-v-dogs/training/"</span>
<span class="n">train_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span> <span class="n">rescale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">255.</span> <span class="p">)</span>

<span class="n">train_generator</span> <span class="o">=</span> <span class="n">train_datagen</span><span class="p">.</span><span class="n">flow_from_directory</span><span class="p">(</span><span class="n">TRAINING_DIR</span><span class="p">,</span>
                                                    <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                                                    <span class="n">class_mode</span><span class="o">=</span><span class="s">'binary'</span><span class="p">,</span>
                                                    <span class="n">target_size</span><span class="o">=</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">))</span>

<span class="c1"># the same for validation
# output: Found 2700 images belonging to 2 classes.
</span></code></pre></div></div>

<h3 id="train">Train</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">fit_generator</span><span class="p">(</span><span class="n">train_generator</span><span class="p">,</span>
                              <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                              <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">validation_data</span><span class="o">=</span><span class="n">validation_generator</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="image-augmentation">Image Augmentation</h2>

<p>👉 Notebook: <a href="https://dinhanhthi.com/github-html?https://github.com/dinhanhthi/deeplearning.ai-courses/blob/master/TensorFlow%20in%20Practice/course-2/week-2/notebook_1_Cats_v_Dogs_Augmentation.html">Cats v Dogs using augmentation</a> &amp; <a href="https://dinhanhthi.com/github-html?https://github.com/dinhanhthi/deeplearning.ai-courses/blob/master/TensorFlow%20in%20Practice/course-2/week-2/notebook_3_Cats_vs_Dogs_using_augmentation_Question-FINAL.html">the final exercise</a> (more data). <br />
👉 Notebook: <a href="https://dinhanhthi.com/github-html?https://github.com/dinhanhthi/deeplearning.ai-courses/blob/master/TensorFlow%20in%20Practice/course-2/week-2/notebook_2_horse_human.html">Human vs Horse using augmentation</a>.</p>

<ul class="noindent">
  <li>Create multiple “other” images from original images without saving them to the memory + quickly.</li>
  <li>Image augmentation helps you avoid overfitting.</li>
  <li>Meaning of params, check <a href="https://www.coursera.org/lecture/convolutional-neural-networks-tensorflow/coding-augmentation-with-imagedatagenerator-kiCPT">this video</a>.</li>
  <li>Broad set of images for BOTH training and testing sets!</li>
  <li><a href="https://www.tensorflow.org/api_docs/python/tf/keras/preprocessing/image/ImageDataGenerator">ImageDataGenerator on TF</a>.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># The different from the code in the previous section!
</span>
<span class="n">train_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span>
    <span class="n">rescale</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">255</span><span class="p">,</span>             <span class="c1"># rescale
</span>    <span class="n">rotation_range</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>          <span class="c1"># rotate randomly between 0 &amp; 40 degrees (max 180)
</span>    <span class="n">width_shift_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>      <span class="c1"># offset horizontally 20%
</span>    <span class="n">height_shift_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>     <span class="c1"># offset vertically 20%
</span>    <span class="n">shear_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">zoom_range</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">horizontal_flip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">fill_mode</span><span class="o">=</span><span class="s">'nearest'</span>         <span class="c1"># fill any pixel may been lost by the "nearest" ones
</span><span class="p">)</span>

<span class="n">validation_datagen</span> <span class="o">=</span> <span class="n">ImageDataGenerator</span><span class="p">(</span><span class="n">rescale</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span>
</code></pre></div></div>

<p class="img-100 pop"><img src="/img/post/mooc/tf/image-augmentation.png" alt="Image augmentation illustration" />
<em>An illustration of image augmentation <a href="https://developer.apple.com/documentation/createml/improving_your_model_s_accuracy">from apple</a>.</em></p>

<h2 id="transfer-learning">Transfer learning</h2>

<p>👉 Notebook: <a href="https://dinhanhthi.com/github-html?https://github.com/dinhanhthi/deeplearning.ai-courses/blob/master/TensorFlow%20in%20Practice/course-2/week-3/notebook_1_Coding%20transfer%20learning%20from%20the%20inception%20mode.html">Coding transfer learning from the inception mode</a>. ➪ <a href="https://www.coursera.org/lecture/convolutional-neural-networks-tensorflow/exploring-transfer-learning-with-inception-ZQ6dw">Video</a> explains this notebook. <br />
👉 Notebook: <a href="https://dinhanhthi.com/github-html?https://github.com/dinhanhthi/deeplearning.ai-courses/blob/master/TensorFlow%20in%20Practice/course-2/week-3/notebook_2_Horses_vs_humans_using_Transfer_Learning_Question-FINAL.html">Horses v Humans using callBack, Augmentation, transfer learning</a> (final exercise).</p>

<ul class="noindent">
  <li><strong>Transfer learning</strong> = Taking existing model that’s trained on far more data + use the features that model learned.</li>
  <li>(Tensorflow tutorial) <a href="https://www.tensorflow.org/tutorials/images/transfer_learning">Transfer learning and fine-tuning</a></li>
  <li><a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/43022.pdf"><strong>Inception/GoogLeNet network</strong></a>: Inception Modules are used in CNN to allow for more efficient computation and deeper Networks through a dimensionality reduction with stacked 1x1 convolutions. The modules were designed to solve the problem of computational expense, as well as overfitting, among other issues. The solution, in short, is to <em>take multiple kernel filter sizes within the CNN, and rather than stacking them sequentially, ordering them to operate on the same level.</em> <sup><a href="https://www.analyticsvidhya.com/blog/2018/10/understanding-inception-network-from-scratch " target="_blank">[ref]</a></sup>
 Check more in <a href="#references">Refereces</a> 1, 2, 3.</li>
  <li><strong>Dropout</strong>: remove a random number of neurons in your NN. It works well because:
    <ul>
      <li>neighboring neurons often end up with similar weights, which can lead to overfitting.</li>
      <li>a neuron can over-weigh the input from a neuron in the previous layer</li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="n">Model</span>

<span class="c1"># download snapshot of weights
</span>
<span class="kn">from</span> <span class="nn">tensorflow.keras.applications.inception_v3</span> <span class="kn">import</span> <span class="n">InceptionV3</span>
<span class="n">local_weights_file</span> <span class="o">=</span> <span class="s">'/tmp/inception_v3_weights.h5'</span>

<span class="n">pre_trained_model</span> <span class="o">=</span> <span class="n">InceptionV3</span><span class="p">(</span>
    <span class="n">input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="n">include_top</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="c1"># Inception v3 has a fully-connected
</span>                         <span class="c1"># layer at the top -&gt; False to ignore
</span>                         <span class="c1"># it and get straight to the convolution.
</span>    <span class="n">weights</span> <span class="o">=</span> <span class="bp">None</span> <span class="c1"># don't wana use built-in weights
</span><span class="p">)</span>

<span class="n">pre_trained_model</span><span class="p">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">local_weights_file</span><span class="p">)</span> <span class="c1"># but use the snapshot downloaded
</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">pre_trained_model</span><span class="p">.</span><span class="n">layers</span><span class="p">:</span>
    <span class="n">layer</span><span class="p">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="bp">False</span> <span class="c1"># lock pretrained layers
</span>                            <span class="c1"># they're not going to be trained
</span>                            <span class="c1"># with this code
</span>
<span class="c1"># pre_trained_model.summary()   # DON'T DO THAT, IT'S HUGE!!!
</span></code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># By default, the output of the last layer will be 3x3 but we wanna
# get more info, so we grap layer "mixed7" from inception and take its output
# mixed7: output of a lot of conv that are 7x7
</span><span class="n">last_layer</span> <span class="o">=</span> <span class="n">pre_trained_model</span><span class="p">.</span><span class="n">get_layer</span><span class="p">(</span><span class="s">'mixed7'</span><span class="p">)</span>
<span class="n">last_output</span> <span class="o">=</span> <span class="n">last_layer</span><span class="p">.</span><span class="n">output</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">tensorflow.keras.optimizers</span> <span class="kn">import</span> <span class="n">RMSprop</span>

<span class="c1"># Define a new model
</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Flatten</span><span class="p">()(</span><span class="n">last_output</span><span class="p">)</span> <span class="c1"># Take the output (mixed7) from inception model
</span>                                  <span class="c1"># last_output: look like dense model
</span>                                  <span class="c1">#     -&gt; input of the new model
</span>                                  <span class="c1"># Starting by flatting the input
</span><span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'relu'</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># randomly remove 20% of neurons (avoid overfitting)
</span><span class="n">x</span> <span class="o">=</span> <span class="n">layers</span><span class="p">.</span><span class="n">Dense</span>  <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'sigmoid'</span><span class="p">)(</span><span class="n">x</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">pre_trained_model</span><span class="p">.</span><span class="nb">input</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">RMSprop</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">),</span>
              <span class="n">loss</span> <span class="o">=</span> <span class="s">'binary_crossentropy'</span><span class="p">,</span>
              <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s">'accuracy'</span><span class="p">])</span>
</code></pre></div></div>

<h2 id="multi-class-classification">Multi-class classification</h2>

<p>👉 Notebook: Rock Paper Scissors. <br />
👉 Notebook: MNIST.</p>

<ul class="noindent">
  <li><a href="http://www.laurencemoroney.com/rock-paper-scissors-dataset/">Rock-Paper-Scissors dataset</a> (generated using CGI techniques)</li>
</ul>

<p>The codes are quite the same as in the case of binary classification, the differences are</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">train_generator</span> <span class="o">=</span> <span class="n">train_datagen</span><span class="p">.</span><span class="n">flow_from_directory</span><span class="p">(</span>
    <span class="p">...</span>
    <span class="n">class_mode</span><span class="o">=</span><span class="s">'categorical'</span> <span class="c1"># 'binary' for binary
</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="p">...</span>
    <span class="n">tf</span><span class="p">.</span><span class="n">keras</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s">'softmax'</span><span class="p">)</span> <span class="c1"># 'sigmoid' for binary
</span><span class="p">])</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span><span class="p">.</span><span class="nb">compile</span><span class="p">(</span>
    <span class="n">loss</span><span class="o">=</span><span class="s">'categorical_crossentropy'</span> <span class="c1"># 'binary_lossentropy' for binary
</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="more">More</h2>

<ul>
  <li>Applying Convolutions on top of our Deep neural network will make training ➪ It depends on many factors. It might make your training faster or slower, and a poorly designed Convolutional layer may even be less efficient than a plain DNN!</li>
</ul>

<h2 id="references">References</h2>

<ol>
  <li><a href="https://www.analyticsvidhya.com/blog/2018/10/understanding-inception-network-from-scratch/">Inception Network - Implementation Of GoogleNet In Keras</a></li>
  <li><a href="https://cv-tricks.com/cnn/understand-resnet-alexnet-vgg-inception/">ResNet, AlexNet, VGGNet, Inception: Understanding various architectures of Convolutional Networks – CV-Tricks.com</a></li>
  <li><a href="https://medium.com/coinmonks/paper-review-of-googlenet-inception-v1-winner-of-ilsvlc-2014-image-classification-c2b3565a64e7">Review: GoogLeNet (Inception v1)— Winner of ILSVRC 2014 (Image Classification)</a></li>
  <li><a href="https://www.tensorflow.org/tutorials/images/transfer_learning">Transfer learning and fine-tuning  -  TensorFlow Core</a></li>
</ol>



<!-- <div class="box-error">
<h4>Notice an error?</h4>
Everything on this site is <a href="https://github.com/baotrung217/dinhanhthi.com" target="_blank">published</a> on Github. If you find something wrong, <a href="https://github.com/dinhanhthi/dinhanhthi.com/edit/master/_posts/mooc/2020-08-24-deeplearning-ai-tensorflow-course-2.md" target="_blank">just edit it</a> or <a href="mailto:baotrung217@gmail.com?subject=Suggest to edit post 'TF 2 - CNN in TensorFlow'">tell me</a> about it.
</div> -->

<div class="sec-comment">

  

  <button class="btn btn-info w-100" id="show-comments" onclick="load_comment();return false;">
    If you find something wrong or need a comment, click here.
  </button>

  <div id='comment-box' style="display: none;">
    <script src="https://utteranc.es/client.js"
            repo="dinhanhthi/dinhanhthi.com"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
  </div>

  <script>
    var comment_loaded = false;
    function load_comment() {
        if (!comment_loaded)  {
            comment_loaded = true;
            document.getElementById("show-comments").style.display = "none";
            document.getElementById("comment-box").style.display = "block";
        }
    }
  </script>
</div>

<div class="modal fade" id="imagemodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg modal-xl">
    <div class="modal-content">
      <div class="modal-body">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <img src="" class="imagepreview" style="width: 100%;" >
      </div>
    </div>
  </div>
</div>



          </article >
        </div>
      </div>
    </div>
  </section>
</main>



  <footer class="footer">
    <div class="container">
  <div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6 text-center p-3">
      <div class="footer-info">
        <a href="https://baotrung.dev" target="_blank">Trung</a>
        &nbsp;&copy;&nbsp;
        2022
        &nbsp;&bull;&nbsp;
        <a href="http://localhost:4000/about-the-notes">
          About the notes
        </a>
        &nbsp;&bull;&nbsp;
        <a href="https://pobo.dinhanhthi.com" target="_blank">
          Po Bo
        </a>
        &nbsp;&bull;&nbsp;
        <a href="/for-me-only">
          For me only
        </a>
        &nbsp;&bull;&nbsp;
        <a class="donate" href="http://localhost:4000/donate">
          Support Trung
        </a>
      </div>
    </div>
  </div>
</div>

  </footer>

  





  

  <script src="https://code.jquery.com/jquery-1.10.1.min.js" integrity="sha256-SDf34fFWX/ZnUozXXEH0AeB+Ip3hvRsjLwp6QNTEb3k=" crossorigin="anonymous" async></script>

  <!-- scrolling-toc -->
  <script src="http://localhost:4000/js/scrolling-toc.js" type="text/javascript" async></script>

  <!-- bootstrap -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous" async></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous" async></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous" async></script>

  <script src="http://localhost:4000/js/click_to_zoom.js" async></script>

  <script src="http://localhost:4000/js/anchor.js" async></script>

</body>
</html>
